# WB Wildberries Analytics Service

Полноценный аналитический сервис для сбора максимум данных о товарах Wildberries с многоуровневыми фолбэками и публичными CSV для интеграции с Google Sheets.

## Основные задачи
1. Получать максимум данных по артикулу: цена, название, бренд, продавец (ID и имя), рейтинг, отзывы, изображения, остатки, склады, валюта, dest (регион запроса), источник (какой слой фолбэка), временная метка.
2. Давать сверхпростой публичный CSV эндпоинт `price,name` для Google Sheets (без авторизации, надёжный формат).
3. Предоставлять расширенный интерфейс (MAX UI) под авторизацией для ручного анализа.
4. Стать базой для будущей аналитики: динамика цен, густота остатков, доступность по регионам, качество карточки (изображения / отзывы).

## Архитектура и фолбэки
Цепочка получения данных о цене и товаре:
```
API v2  →  API v1  →  Basket CDN  →  HTML страницы товара
```
Каждый уровень добавляет шанс получить валидную цену/название. Если предыдущий слой не дал данных — переходим к следующему. Для изображений используется генерация прямых URL + прокси `/wb-image`.

## Авторизация
Приватные маршруты защищены простой сессией (логин `admin`, пароль `tarelkastakan`). Рекомендуется вынести в переменные окружения:
```
ADMIN_USER=admin
ADMIN_PASS=tarelkastakan
```

Публичные эндпоинты НЕ требуют авторизации: `/wb-price-csv`, `/wb-price-plain`.

## Эндпоинты

| Маршрут | Тип | Описание |
|---------|-----|----------|
| `/` | HTML (auth) | MAX UI: интерактивная таблица всех данных по артикулу |
| `/wb-price` | JSON (auth) | Базовая цена + имя + бренд (диагностика попыток) |
| `/wb-price-plain` | TEXT | Только число (цена) для простых формул |
| `/wb-price-csv` | CSV | Публично: `price,name` (2 колонки) для Google Sheets |
| `/wb-max` | JSON (auth) | Максимальный пакет данных по товару |
| `/wb-max-csv` | CSV (auth) | Максимальный пакет в одной строке (включая sellerName) |
| `/wb-image` | IMAGE | Прокси для картинки товара с fallback цепочкой |
| `/wb-raw` | JSON (auth) | Сырой ответ API Wildberries (v1/detail) для отладки |

### Пояснение ключевых полей
| Поле | Значение |
|------|----------|
| `price` | Минимальная найденная цена (конвертирована из *_U / 100) |
| `name` | Название товара |
| `brand` | Бренд товара |
| `sellerId` | Идентификатор продавца на WB |
| `sellerName` | Человекочитаемое имя продавца (HTML парсинг) |
| `rating` | Рейтинг товара (0..5) |
| `feedbacks` | Количество отзывов |
| `images` | Количество изображений (pics/images) |
| `mainImage` | URL основной картинки (webp с fallback) |
| `stocksQty` | Сумма остатков по всем размерам и складам |
| `warehouses` | Список ID складов, где есть остатки |
| `destUsed` | Георегион (dest) который вернул карточку |
| `currency` | Валюта (RUB/KGS/KZT) по домену |
| `source` | Слой фолбэка (v2/detail, v1, basket-cdn, html-*) |

### Пример запроса MAX JSON
```
GET /wb-max?nm=307325849&domain=ru
```
Ответ (сокращённо):
```json
{
	"nm": "307325849",
	"name": "Название товара",
	"brand": "Бренд",
	"sellerId": "254065",
	"sellerName": "ООО Пример",
	"price": 599.0,
	"currency": "RUB",
	"rating": 4.7,
	"feedbacks": 152,
	"images": 5,
	"stocksQty": 320,
	"warehouses": ["206348","117986"],
	"destUsed": "-1257786",
	"source": "v2/detail",
	"domain": "ru"
}
```

### Пример CSV для Sheets
```
GET /wb-price-csv?nm=307325849
```
Ответ:
```
price,name
599,"Название товара"
```

## Интеграция с Google Sheets
Минимальная формула для цены (артикул в ячейке C3):
```
=INDEX(IMPORTDATA("https://your-domain/wb-price-csv?nm=" & C3),2,1)
```
Название:
```
=INDEX(IMPORTDATA("https://your-domain/wb-price-csv?nm=" & C3),2,2)
```
Если нужно массовое обновление по диапазону артикулов — используйте Google Apps Script и цикл, дергающий `/wb-price-csv`.

## Логика извлечения цены
Собираются кандидаты из полей:
```
salePriceU, clientSalePriceU, basicPriceU, priceU, fullPriceU,
sizes[].price.{basic,product,total}, sizes[].{salePriceU, priceU}
```
Берётся минимальное положительное значение → делится на 100.

## Изображения
`mainImage` строится из шаблонов basket CDN. При ошибках в UI срабатывает JS fallback цепочка и, в крайнем случае, SVG-заглушка.
Можно напрямую запросить через прокси:
```
/wb-image?nm=307325849&pic=1
```

## Быстрый старт локально
```
git clone https://github.com/Oshondoi/wb-service
cd wb-service
npm install
npm start
```
По умолчанию порт: `3000` → `http://localhost:3000/login`

## Ограничения
- Публичный эндпоинт не кэширует данные (ради свежести). Можно позже добавить TTL.
- HTML парсинг может ломаться при изменении верстки WB.
- Локальный контейнер может не всегда получать ответы (сетевые ограничения).

## Roadmap / Дальнейшее развитие
| Задача | Описание |
|--------|----------|
| Batch CSV | `/wb-batch-csv?nm=111,222,333` для снижения количества запросов из Sheets |
| Кэш цен | In-memory / Redis TTL (30–120 сек) для нагруженных сценариев |
| Rate limiting | Защита публичных эндпоинтов от спама |
| История цен | Авто логирование и выдача динамики (JSON/CSV) |
| Аналитика скидок | Расчёт % скидки, базовая/текущая цена, маржа (если доступно) |
| Качество карточки | Скоринг по изображениям, отзывам, рейтингу |
| География остатков | Сегментация складов по регионам (Москва/СПб/...) |
| Расширенные seller insights | Группировка по продавцу, суммарные остатки, средняя цена |

## Рекомендации по улучшению безопасности
- Перенести креды в `.env` (не хранить пароль в репозитории).
- Добавить опциональный ключ (query `key=`) к публичному CSV при росте трафика.
- Логировать ошибки/таймауты в отдельный журнал.

## Лицензия
Проект учебно-аналитический. Лицензия не указана (по умолчанию все права принадлежат автору репозитория).

---
Готово к расширению: добавляйте новые поля и эндпоинты, не ломая публичный формат `price,name`.
