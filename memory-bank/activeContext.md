# Active Context

Current Focus:
- Показ ВСЕХ продавцов (не только ИП): название юрлица с ID в скобках
- **КАТЕГОРИИ: парсинг из API поля `entity` - реальные русские названия без статичных словарей**
- Добавлены колонки: Категория товара и Цвет
- Упрощена структура данных: убрано разделение на storeName/sellerName
- Критическая оптимизация производительности: устранение медленных запросов
- Склады: показывать названия складов и количество в формате `Название — N шт`

Recent Changes (Dec 2, 2025):

**LATEST UPDATE - CATEGORY PARSING FROM API:**
- **CRITICAL CHANGE**: Категории теперь парсятся из поля `product.entity` (API v2)
- **DATA SOURCE**: Поле `entity` содержит название категории на русском языке
- **REMOVED**: Удалён статичный маппинг `subjectId → название` (40+ строк кода)
- **EXAMPLES**: "кроссовки" → "Кроссовки", "юбки" → "Юбки", "зонты пляжные" → "Зонты пляжные"
- **FORMATTING**: Первая буква автоматически становится заглавной для красоты
- **BENEFIT**: Автоматическое покрытие ВСЕХ категорий WB без ручного маппинга
- **PERFORMANCE**: Нулевые накладные расходы, данные уже в API
- **CSV**: Обновлены оба endpoint (/wb-max и /wb-max-csv)

**LATEST UPDATE - SIMPLIFIED SELLER DATA:**
- **DECISION**: Отключен парсинг юридических лиц (WB блокирует все методы)
- **CURRENT STATE**: Показываем только sellerId + storeName (торговое название из API)
- **TWO COLUMNS**: 
  1. `Продавец (ID)` - показывает только ID продавца (например "ID: 1399211")
  2. `Магазин` - торговое название из `product.supplier` (например "Мариям")
- **REASON**: Wildberries блокирует парсинг (код 498, капча, анти-бот защита)
- **FUTURE**: Для полных юрлиц требуется Puppeteer/Selenium на отдельном VPS
- **DATABASE**: `sellers-db.json` оставлен для справки но не используется
- **PERFORMANCE**: Быстрая загрузка ~1-3 сек без попыток парсинга

Previous Changes:
- **NEW FEATURE**: Добавлены колонки "Категория" и "Цвет" между Продавцом и Ценой
- **DATA SOURCE**: Категория извлекается из `product.subjectId` с маппингом на названия (40+ категорий)
- **DATA SOURCE**: Цвет извлекается из `product.colors[0].name` (берем ПЕРВЫЙ цвет - основной для данного артикула)
- **FIX**: Цвет теперь показывает только один цвет товара, а не все через запятую
- **MAPPING**: Расширенный маппинг категорий: одежда, обувь, электроника, дом, красота, детям, авто
- **MAJOR CHANGE**: Убрано ограничение на ИП - теперь показываем ВСЕХ продавцов
- **UI CHANGE**: Колонка "Продавец (ID)" показывает: `Название продавца (ID продавца)`
- **SIMPLIFICATION**: Убрано поле `sellerName` - теперь используется только `storeName` из `product.supplier`
- **SIMPLIFICATION**: Удалена проверка на ИП перед парсингом - берём название из API для всех
- **DATABASE**: В базе 3 продавца (KOTON, QUATRO, АНТАРЕС) - легко расширяется
- **CSV UPDATE**: Обновлён формат CSV - добавлены `category` и `color`, убрана `sellerName`
- **CRITICAL FIX**: Удалён медленный `fetchStoreNameFromProductPage` который делал 3+ HTTP-запроса
- **CRITICAL FIX**: Упрощён `extractPrice` - убраны дублирующиеся проверки, оставлены только рабочие поля
- **CRITICAL FIX**: Удалено дублирование функции `summarizeStocks` (была определена дважды)
- **CRITICAL FIX**: Добавлены недостающие функции `safeGet` и `currencyByDomain` в wb-max-csv
- **UI FIX**: Исправлена проверка цены - теперь `price !== null && price > 0` вместо `typeof price === 'number'`
- **UI FIX**: Исправлены индексы innerHTML - правильно отображаются фото, склады и статус
- **UI FIX**: Товары без остатков показывают "нет в наличии" вместо "0.00"
- **CRITICAL FIX**: Название магазина берётся из `product.supplier` в API v2 (не требует парсинга!)
- Результат: загрузка **~2-8 сек** (с учетом парсинга), показываем полные юрлица или краткие названия
- UI: артикул — ссылка на KG
- UI: колонка `Склады` показывает `Название — N шт`, модель FBO/FBS

Next Steps:
- Добавить кэширование часто запрашиваемых товаров (опционально)
- Расширять словарь `wh → название` по наблюдениям

Decisions:
- Сохранять `/wb-price-csv` публичным и минимальным.
- HTML парсинг имени продавца использовать только для JSON/UI, не утяжеляя CSV.
- В UI поддерживать простоту чтения через раздельные колонки.
- Данные по складам считаются из публичного `sizes[].stocks` (агрегация по `wh`).
- Для аналитики конкурентов используем только публичные данные WB (без приватных ключей).

Preferences:
- Minimal public endpoints; robust fallbacks; readable UI.

Learnings:
- Wildberries APIs can vary; layered fallbacks are essential.
- Sheets `IMPORTDATA` returns headers+data; use `INDEX` to select cells.
