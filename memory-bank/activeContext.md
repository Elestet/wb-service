# Active Context

Current Focus:
- Показ ВСЕХ продавцов (не только ИП): название юрлица с ID в скобках
- Добавлены колонки: Категория товара и Цвет
- Упрощена структура данных: убрано разделение на storeName/sellerName
- Критическая оптимизация производительности: устранение медленных запросов
- Склады: показывать названия складов и количество в формате `Название — N шт`

Recent Changes (Dec 2, 2025):

**LATEST UPDATE - LIVE PARSING OF LEGAL ENTITIES:**
- **BREAKTHROUGH**: Включен АКТИВНЫЙ парсинг юридических лиц для ВСЕХ продавцов с WB!
- **MECHANISM**: Трёхуровневая система получения данных о продавце:
  1. Проверка статической базы `sellers-db.json` (3 продавца: KOTON, QUATRO, АНТАРЕС)
  2. **LIVE PARSING**: Парсинг страницы продавца `wildberries.{kg,kz,ru}/seller/{sellerId}`
  3. Fallback на краткое торговое название из `product.supplier`
- **CACHING**: Добавлен Map-кэш `LEGAL_NAMES_CACHE` - один продавец парсится только 1 раз за сессию
- **ANTI-BLOCK**: Улучшены HTTP-заголовки (Chrome 120 User-Agent, полный набор Sec-Fetch-*)
- **ANTI-BLOCK**: Случайные задержки 0.5-2 сек между запросами к разным доменам
- **PARSING**: Регулярные выражения для извлечения ООО/ИП/АО из HTML реквизитов продавца
- **ROBUSTNESS**: При блокировке WB (код 498) система использует fallback без остановки
- **FLOW**: `/wb-max` и `/wb-max-csv` теперь вызывают `fetchLegalEntityName()` для каждого sellerId
- **RESULT**: Для ЛЮБОГО артикула система пытается получить полное юридическое лицо продавца!

Previous Changes:
- **NEW FEATURE**: Добавлены колонки "Категория" и "Цвет" между Продавцом и Ценой
- **DATA SOURCE**: Категория извлекается из `product.subjectId` с маппингом на названия (40+ категорий)
- **DATA SOURCE**: Цвет извлекается из `product.colors[0].name` (берем ПЕРВЫЙ цвет - основной для данного артикула)
- **FIX**: Цвет теперь показывает только один цвет товара, а не все через запятую
- **MAPPING**: Расширенный маппинг категорий: одежда, обувь, электроника, дом, красота, детям, авто
- **MAJOR CHANGE**: Убрано ограничение на ИП - теперь показываем ВСЕХ продавцов
- **UI CHANGE**: Колонка "Продавец (ID)" показывает: `Название продавца (ID продавца)`
- **SIMPLIFICATION**: Убрано поле `sellerName` - теперь используется только `storeName` из `product.supplier`
- **SIMPLIFICATION**: Удалена проверка на ИП перед парсингом - берём название из API для всех
- **DATABASE**: В базе 3 продавца (KOTON, QUATRO, АНТАРЕС) - легко расширяется
- **CSV UPDATE**: Обновлён формат CSV - добавлены `category` и `color`, убрана `sellerName`
- **CRITICAL FIX**: Удалён медленный `fetchStoreNameFromProductPage` который делал 3+ HTTP-запроса
- **CRITICAL FIX**: Упрощён `extractPrice` - убраны дублирующиеся проверки, оставлены только рабочие поля
- **CRITICAL FIX**: Удалено дублирование функции `summarizeStocks` (была определена дважды)
- **CRITICAL FIX**: Добавлены недостающие функции `safeGet` и `currencyByDomain` в wb-max-csv
- **UI FIX**: Исправлена проверка цены - теперь `price !== null && price > 0` вместо `typeof price === 'number'`
- **UI FIX**: Исправлены индексы innerHTML - правильно отображаются фото, склады и статус
- **UI FIX**: Товары без остатков показывают "нет в наличии" вместо "0.00"
- **CRITICAL FIX**: Название магазина берётся из `product.supplier` в API v2 (не требует парсинга!)
- Результат: загрузка **~2-8 сек** (с учетом парсинга), показываем полные юрлица или краткие названия
- UI: артикул — ссылка на KG
- UI: колонка `Склады` показывает `Название — N шт`, модель FBO/FBS

Next Steps:
- Добавить кэширование часто запрашиваемых товаров (опционально)
- Расширять словарь `wh → название` по наблюдениям

Decisions:
- Сохранять `/wb-price-csv` публичным и минимальным.
- HTML парсинг имени продавца использовать только для JSON/UI, не утяжеляя CSV.
- В UI поддерживать простоту чтения через раздельные колонки.
- Данные по складам считаются из публичного `sizes[].stocks` (агрегация по `wh`).
- Для аналитики конкурентов используем только публичные данные WB (без приватных ключей).

Preferences:
- Minimal public endpoints; robust fallbacks; readable UI.

Learnings:
- Wildberries APIs can vary; layered fallbacks are essential.
- Sheets `IMPORTDATA` returns headers+data; use `INDEX` to select cells.
